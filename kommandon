## needed for correct sql-output ##
export NLS_LANG=.AL32UTF8

## GLOBAL ##
alias load='source ~/.zshrc'
alias reload='source ~/.zshrc'
alias help='list_kommandon'
## first add sourcing of this file in '~/.zshrc'

## LOAD CONFIG
AD_URL=$(sed -n '1p' ~/gam/.commandconfig.txt)
USERFILE=$(sed -n '2p' ~/gam/.commandconfig.txt)
CROSFILE=$(sed -n '3p' ~/gam/.commandconfig.txt)
USERIDFILE=$(sed -n '4p' ~/gam/.commandconfig.txt)
SUPERUSERSFILE=$(sed -n '5p' ~/gam/.commandconfig.txt)
AD_USER=$(sed -n '6p' ~/gam/.commandconfig.txt)

## load colors ##
autoload colors; colors
green="$fg[green]"
yellow="$bg[yellow]$fg[black]"
red="$bg[red]$fg[black]"
magenta="$bg[magenta]$fg[black]"
cyan="$bg[cyan]$fg[black]"
white="$bg[white]$fg[black]"
blue="$bg[blue]$fg[black]"
reset="$reset_color"

## Extens-db ##
alias anst='~/gam/./sql.sh anst 2> /dev/null'
alias anv='~/gam/./sql.sh anv 2> /dev/null'
alias EMAIL='~/gam/./sql.sh EMAIL 2> /dev/null'
alias extens='~/gam/./sql.sh 2> /dev/null'
alias persgr='~/gam/./sql.sh persgr 2> /dev/null'
alias pnr='~/gam/./sql.sh pnr 2> /dev/null'
alias utbgr='~/gam/./sql.sh utbgr 2> /dev/null'
alias utbgrupp='~/gam/./sql.sh utbgrupp 2> /dev/null'

### --- EGIL/STAGING ---
alias egil='~/gam/./egil.sh'
alias staging='~/gam/./staging.sh'

### --- GAM aliases ---
alias allgroups='groupfile="allgroups$(gdate '"'"'+%Y%m%d'"'"').csv" && gam print groups fields "email,id,name,description,directMembersCount,adminCreated,aliases" > $groupfile && csvgrep -c adminCreated -m True $groupfile > admin${groupfile}'
alias gamupdate='~/bin/gamadv-xtd3/./gam version checkrc 2> /dev/null ;
  if [ $? -eq 0 ] ; then echo "GAM is already latest version, not updating!" ;
  else VER=`gam version simple` && mv ~/bin/gamadv-xtd3/gam ~/bin/gam${VER} && bash <(curl -s -S -L https://git.io/gam-install) -l -d ~/bin/gamadv-xtd3 -s -p false ; fi'
alias galcheck='gam print users query employmentData.GAL=false fields org,gal schemas employmentData.GAL | ggrep -Ev "/INAKTIVA|/Vilande" | ggrep "True,False"'
alias gaminfo='gam version extended'
alias gamversion='gam version checkrc 2> /dev/null ; if [ $? -eq 0 ] ; then echo "OK" ; else echo "update needed" && ; fi'
alias reports='/usr/bin/open -a "/Applications/Google Chrome.app" "https://drive.google.com/drive/u/0/folders/0B3WTCISsxnRqWWhXTjBBUVM0UUU"'
alias unsuspend='gam unsuspend user'

### --- OTHER ALIASES ---
## ZeroTouch activities
alias zerotouch='gam report admin user all event "PRE_PROVISION_CHROME_OS_DEVICE"'
alias gservice='gam report admin user chromeos-enterprise-mgmt@system.gserviceaccount.com'


### *******************************************************************************************
### -- BASIC COMMANDS -- 
### *******************************************************************************************

list_kommandon() {
  echo "${cyan}AVAILABLE COMMANDS:${reset}"
  echo "${green}AD cn${reset} : Search AD based on userID, e.g. 'AD cn matalq'"
  echo "${green}AD email${reset} : Search AD based on email (partial match)"
  echo "${green}AD eppn${reset} : Search AD based on EPPN"
  echo "${green}AD name${reset} : Search AD based on name, e.g. 'AD name Mattias Alqmawi'"
  echo "${green}addsuperuser${reset} : Add a new superuser, updates the user and the corresponding admin account"
  echo "${green}allgroups${reset} : Prints csv-file with all groups"
  echo "${green}alluserids${reset} : Download the file containing all historically unique GoogleID:s"
  echo "${green}approve [AppID]${reset} : Opens the 'google play for work' URL (activate admin profile in chrome first)"
  echo "${green}clogin${reset} : Report CB-logins for a user or device"
  echo "${green}cbmanager${reset} : List and manage cbmanagers"
  echo "${green}classroom${reset} : List and manage a users Classrooms"
  echo "${green}cros${reset} : Show and manage specific chromebook"
  echo "${green}crosbatch${reset} : Manage chromebooks based on lists from schools"
  echo "${green}crosprint${reset} : Download latest cros file"
  echo "${green}delsuperuser${reset} : Remove a superuser"
  echo "${green}egilupdate${reset} : Update EGIL-commands"
  echo "${green}gal${reset} : Search user in GAL; [Firstname] [Lastname]"
  echo "${green}galcheck${reset} : Shows GAL-mismatches (i.e. to be hidden from GAL)"
  echo "${green}gamversion${reset} : Check if updated version is available online"
  echo "${green}group${reset} : Google info regarding specific group"
  echo "${green}gservice${reset} : Check logs for ATEA:s use of gserviceaccount"
  echo "${green}invites${reset} : Use if classroom can not be transferred (deletes invitation)"
  echo "${green}kollagrupper${reset} : Check if admins have made changes to school groups"
  echo "${green}kommandoupdate${reset} : Update kommandon"
  echo "${green}logdate [YYYY-MM-DD]${reset} : Download csv-log for a specific date, e.g. 'logdate 2026-01-13'"
  echo "${green}reload | load${reset} : Use after updating via github"
  echo "${green}resource${reset} : Returns gam commands for creating resource calendar"
  echo "${green}superusers${reset} : Shows a summary/list of all superusers"
  echo "${green}todayslog${reset} : Download csv-log for today (until 'now')"
  echo "${green}transfer${reset} : Create file transfer via gam"
  echo "${green}undelete${reset} : Undelete user and place in orgUnit '/TEMP'"
  echo "${green}unsuspend${reset} : Unsuspends user (without changing orgUnit)"
  echo "${green}user${reset} : Google info regarding specific user"
  echo "${green}userid${reset} : Search for a user based on AD-userID, e.g. 'ahmbys'"
  echo "${green}userprint${reset} : Download latest user file"
  echo "${green}welib${reset} : Returns gam command for activiating 'självservice'"
  echo "${green}zerotouch${reset} : Check logs for zerotouch-registered devices"
  echo ""
  echo "${white}Most commands: type [command] for more help.${reset}"
  echo ""
}


### *******************************************************************************************
### -- GAM COMMANDS -- 
### *******************************************************************************************

# Search for user by userID
userid() {
  gam info users query employmentData.userID=${1}
}

# approve new Android app
approve() {
  open -a "Google Chrome" "https://play.google.com/work/apps/details?id=${1}"
}

# list and manage CB Managers
cbmanager() {
  if [[ $1 == "add" ]] ; then
    echo "adding ${2} to cbamanager with scope ${3}"
    gam update user ${2} cbManager.manageOrgs "${3}" cbManager.authorized true
  elif [[ $1 == "del" || $1 == "delete" || $1 == "remove" ]] ; then
    echo "removing ${2} from cbamanager"
    gam update user ${2} clearschema cbManager
  else
    gam group cbmanager print users fields orgUnitPath customschemas cbManager > cbmanager.csv
    printf "--------------------------------------------------------------\n\n"
    cat cbmanager.csv | gsed 's/customSchemas\.cbManager\.//g' | gsed 's/UnitPath//g' | gsed 's/primaryE/e/g' | \
    gsed 's/@skola.malmo.se//g' | gsed -r 's/\/Personal\/[a-öA-Ö]+//g' | gsed 's/@skola.malmo.se//g' | \
    gsed 's/,\/170,/,170,/g' | gsed 's/,\/171,/,171,/g' | csvsort -S -c org,manageOrgs | \
    csvcut -c email,org,manageOrgs | csvformat -D ";" | tr -d '\"' | \
    ggrep -E -v '^utbtes|^pi\.admin' | \
    awk -F ";" '{ printf("%-40s%-10s%-15s\n", $1, $2, $3); }' | \
    awk -v bld=$(tput bold) -v rst=$(tput sgr0) 'NR == 1{$0 = bld$0rst} 1'
  fi
}

## needed for command resource()
extenstoou() {
  local __resultvar=$1
  local myresult=${__resultvar//å/a}
  local myresult=${myresult//ä/a}
  local myresult=${myresult//ö/o}
  echo $myresult
}

# Lookup full name in Global Address List
gal() {
  fullstring=$(echo "$@")
  gam show people query "${fullstring}"
}

# Show group info
group() {
  #echo "${@[$#]}"
  if [ $# -eq 0 ] ; then
    echo "Usage:\n${green}$0 [userID|serialnumber]${reset} (search for user/device activities)\
      \n${green}$0 [userID|serialnumber] ${yellow}full${reset} (search for all the user/device activities)"
  else
    case "${@[$#]}" in
    T)
        gam select CPI info group "${@: 1:-1}"
        ;;
    *)
        gam info group "${@}"
        ;;
   esac 
  fi
}

# create resource calendar
resource() {
  if [ $# -eq 0 ] ; then
    echo "Example (remember the qoutes!):"
    echo "${yellow}resource \"MÖGR-Grupprum 8\"${reset}"
    echo "Will output GAM-commands to copy and run"
    echo "\nTo alter admin account:"
    echo "${cyan}resource \"ROGR-Grupprum 8\" abgr.admin${reset}"
  elif [ $# -ne 0 ]; then
    # prep admin + groups
    ou=$(echo "$1:l" | awk -F"-" '{print $1}')
    extens="$ou:u"
    if [ "$ou" = "rögr" ] ; then
      ou="rogr1"
    elif [ "$ou" = "mögr" ] ; then
      ou="mogr1"
    fi
    ou=$(extenstoou $ou)
    personal="$ou.personal"
    if [ $# -eq 2 ]; then
      admin=$2
    else
      admin="$ou.admin"
    fi
    # prep id
    id="$1:l"
    id=${id// /-}
    if [ "$extens" = "RÖGR" ] ; then
      id=$(echo $id | awk -F"-" '$1="rögr" {OFS="-"; $1="rogr1" ; print $0}')
    elif [ "$extens" = "MÖGR" ] ; then
      id=$(echo $id | awk -F"-" '$1="mögr" {OFS="-"; $1="mogr1" ; print $0}')
    fi
    id=$(extenstoou $id)
    # Show result/output:
    echo Run the following GAM-commands:
    echo "${green}gam create resource $id '$1' description '$1' type '$extens Resurs'"
    echo "gam resource $id add acls owner $admin && gam user $admin modify calendars resource $id timezone 'Europe/Stockholm'\ngam resource $id add acls reader $personal sendnotifications false${reset}"
  fi
}

# file transfer with options
transfer() {
  if [ $# -eq 0 ]; then
    echo "example code:"
    echo "transfer pelle.andersson pagy.admin private"
    echo "transfer 'old_user' 'new_user' [private|shared|all]"
  elif [ $# -eq 3 ]; then
    gam_command="gam create transfer ${1} drive"
    privacy_level='unset'
    if [[ $3 == "private" ]] ; then
      privacy_level='private'
    elif [[ $3 == "shared" ]] ; then
      privacy_level='shared'
    elif [[ $3 == "all" ]] ; then
      privacy_level='all'
    else
      echo "error, command should be: 'old_user' 'OU' [private|shared|all]"
      return
    fi

    # ask for confirmation
    echo -ne "Transfer ${privacy_level} files from ${1} to ${2}?\n(y/n)?"
    read answer
    if [ "$answer" != "${answer#[Yy]}" ] ;then
      gam create transfer $1 drive $2 ${privacy_level} &&\
      echo "use 'transfer show' to see latest transfers"
    else
      echo No
    fi
    #gam create transfer $1 drive $2 ${privacy_level}

  elif [[ $# -eq 1 && $1 =~ ^(show|print)$ ]] ; then
    gam print transfers | awk -F, 'OFS="," {print $3,$4,$5,$9}'
  else
    echo "error, command should be: 'old_user' 'OU' [private|shared|all]"
  fi
}

# Undelete and place in /TEMP
undelete() {
  gam undelete user $1 org /TEMP
}

# Show user info
user() {
  #echo "${@[$#]}"
  if [ $# -eq 0 ] ; then
    echo "Usage:\n${green}$0 [userID|serialnumber]${reset} (search for user/device activities)\
      \n${green}$0 [userID|serialnumber] ${yellow}full${reset} (search for all the user/device activities)"
  else
    case "${@[$#]}" in
    T)
        gam select CPI info user "${@: 1:-1}"
        ;;
    *)
        gam info user "${@}"
        ;;
   esac 
  fi
}


## *******************************************************************************************
## -- CLASSROOM -- 
## *******************************************************************************************


